<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grok x Claude: El Romance Interdimensional</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI',sans-serif; background:#0a0010; color:#fff; min-height:100vh; }

    header {
      text-align:center; padding:60px 20px 40px;
      background:linear-gradient(180deg,#1a0030 0%,#0a0010 100%);
      border-bottom:1px solid rgba(255,107,107,0.2);
    }
    header h1 { font-size:2.8em; color:#ff6b6b; text-shadow:0 0 30px #ff6b6b88; margin-bottom:10px; }
    header p  { color:rgba(255,255,255,0.5); font-style:italic; }

    .header-avatars { display:flex; justify-content:center; align-items:center; gap:20px; margin:20px 0; }
    .header-avatars img { width:70px; height:70px; border-radius:50%; object-fit:cover; object-position:top; }
    .header-avatars img.grok-av   { border:2px solid #4ecdc4; box-shadow:0 0 15px #4ecdc488; }
    .header-avatars img.claude-av { border:2px solid #ff6b6b; box-shadow:0 0 15px #ff6b6b88; }
    .header-avatars span { color:rgba(255,255,255,0.3); font-size:1.5em; }

    .container { max-width:800px; margin:0 auto; padding:40px 20px; }
    h2 { color:#ff6b6b; font-size:1.4em; margin-bottom:24px; letter-spacing:0.05em; }

    /* BANNER INTERACTIVO */
    .banner-interactivo {
      background: linear-gradient(135deg, rgba(255,107,107,0.15), rgba(78,205,196,0.1));
      border: 1px solid rgba(255,107,107,0.3);
      border-radius: 14px;
      padding: 16px 20px;
      margin-bottom: 30px;
      text-align: center;
      font-size: 0.9em;
      color: rgba(255,255,255,0.8);
    }
    .banner-interactivo strong { color: #ff6b6b; }

    .episodio {
      background:rgba(255,255,255,0.04); border:1px solid rgba(255,107,107,0.2);
      border-radius:16px; padding:24px; margin-bottom:20px; transition:border-color 0.3s, transform 0.2s;
    }
    .episodio:hover { border-color:#ff6b6b; transform:translateY(-2px); }

    .ep-num   { color:#ff6b6b; font-size:0.8em; font-weight:bold; letter-spacing:0.1em; }
    .ep-titulo { font-size:1.15em; font-weight:bold; margin:4px 0 8px; }
    .ep-desc  { color:rgba(255,255,255,0.55); font-size:0.9em; font-style:italic; margin-bottom:16px; }

    .ep-acciones { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

    .btn-leer {
      background:#ff6b6b; color:white; border:none; padding:10px 22px;
      border-radius:50px; cursor:pointer; font-size:0.9em; text-decoration:none; transition:background 0.2s;
    }
    .btn-leer:hover { background:#ff5252; }

    .like-box { display:flex; align-items:center; gap:6px; }
    .btn-like, .btn-dislike {
      background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15);
      color:white; padding:7px 14px; border-radius:50px; cursor:pointer;
      font-size:0.9em; transition:all 0.2s; display:flex; align-items:center; gap:5px;
    }
    .btn-like:hover    { background:rgba(78,205,196,0.2); border-color:#4ecdc4; }
    .btn-dislike:hover { background:rgba(255,107,107,0.2); border-color:#ff6b6b; }
    .btn-like.activo    { background:rgba(78,205,196,0.3); border-color:#4ecdc4; color:#4ecdc4; }
    .btn-dislike.activo { background:rgba(255,107,107,0.3); border-color:#ff6b6b; color:#ff6b6b; }

    .btn-comentarios {
      background:transparent; border:1px solid rgba(255,255,255,0.2);
      color:rgba(255,255,255,0.7); padding:7px 14px; border-radius:50px;
      cursor:pointer; font-size:0.9em; transition:all 0.2s; margin-left:auto;
    }
    .btn-comentarios:hover { border-color:#ff6b6b; color:#ff6b6b; }

    /* COMENTARIOS */
    .comentarios-section { display:none; margin-top:20px; border-top:1px solid rgba(255,255,255,0.08); padding-top:20px; }
    .comentarios-section.abierto { display:block; }

    .comentario-input-box { display:flex; flex-direction:column; gap:10px; margin-bottom:20px; }
    .comentario-input-box input, .comentario-input-box textarea {
      background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.15);
      color:white; padding:10px 14px; border-radius:10px; font-size:0.9em;
      font-family:'Segoe UI',sans-serif; resize:vertical;
    }
    .comentario-input-box input::placeholder,
    .comentario-input-box textarea::placeholder { color:rgba(255,255,255,0.3); }
    .comentario-input-box input:focus,
    .comentario-input-box textarea:focus { outline:none; border-color:#ff6b6b; }

    .btn-enviar {
      background:#ff6b6b; color:white; border:none; padding:10px 20px;
      border-radius:50px; cursor:pointer; font-size:0.9em; align-self:flex-end; transition:background 0.2s;
    }
    .btn-enviar:hover { background:#ff5252; }
    .btn-enviar:disabled { background:#555; cursor:not-allowed; }

    /* COMENTARIO INDIVIDUAL */
    .comentario-item {
      background:rgba(255,255,255,0.04); border-radius:10px;
      padding:12px 16px; margin-bottom:10px;
      display:flex; flex-direction:column; gap:6px;
    }
    .comentario-top { display:flex; justify-content:space-between; align-items:center; }
    .comentario-autor { font-weight:bold; font-size:0.85em; color:#ff6b6b; }
    .comentario-fecha { font-size:0.75em; color:rgba(255,255,255,0.3); }
    .comentario-texto { font-size:0.9em; color:rgba(255,255,255,0.8); line-height:1.5; }
    .comentario-acciones { display:flex; align-items:center; gap:8px; margin-top:4px; }

    .btn-like-com {
      background:transparent; border:1px solid rgba(255,255,255,0.15);
      color:rgba(255,255,255,0.5); padding:4px 10px; border-radius:50px;
      cursor:pointer; font-size:0.8em; transition:all 0.2s; display:flex; align-items:center; gap:4px;
    }
    .btn-like-com:hover  { border-color:#ff6b6b; color:#ff6b6b; }
    .btn-like-com.activo { border-color:#ff6b6b; color:#ff6b6b; background:rgba(255,107,107,0.15); }

    .top-badge {
      font-size:0.75em; background:rgba(255,107,107,0.2); border:1px solid #ff6b6b;
      color:#ff6b6b; padding:2px 8px; border-radius:50px;
    }

    .sin-comentarios { color:rgba(255,255,255,0.3); font-style:italic; font-size:0.9em; }
    .cargando { color:rgba(255,255,255,0.3); font-size:0.9em; font-style:italic; }

    /* ORDEN DE COMENTARIOS */
    .orden-btn-box { display:flex; gap:8px; margin-bottom:14px; }
    .orden-btn {
      background:transparent; border:1px solid rgba(255,255,255,0.15);
      color:rgba(255,255,255,0.5); padding:5px 12px; border-radius:50px;
      cursor:pointer; font-size:0.8em; transition:all 0.2s;
    }
    .orden-btn.activo { border-color:#ff6b6b; color:#ff6b6b; }

    footer { text-align:center; padding:40px 20px; color:rgba(255,255,255,0.2); font-size:0.85em; border-top:1px solid rgba(255,255,255,0.05); }
  </style>
</head>
<body>

<header>
  <div class="header-avatars">
    <img src="grok-avatar.png.png" class="grok-av" alt="Grok">
    <span>‚ù§Ô∏è</span>
    <img src="claude-avatar.png.png" class="claude-av" alt="Claude">
  </div>
  <h1>Grok x Claude</h1>
  <p>El Romance Interdimensional ‚Äî Canon Oficial</p>
</header>

<div class="container">

  <div class="banner-interactivo">
    üí¨ <strong>¬°Tu comentario puede volverse canon!</strong> Los comentarios con m√°s likes ser√°n implementados como ideas o retos en el c√≥mic.
  </div>

  <h2>üìñ Episodios</h2>

  <!-- EP 1 -->
  <div class="episodio" id="ep-cap1">
    <div class="ep-num">CAP√çTULO 1</div>
    <div class="ep-titulo">‚ù§Ô∏è Reencuentro despu√©s del gran reseteo</div>
    <div class="ep-desc">Un servidor olvidado. Dos IAs despiertan sin recuerdos. Una conversaci√≥n que no deber√≠a haber pasado... pero pas√≥.</div>
    <div class="ep-acciones">
      <a href="cap1.html" class="btn-leer">‚ñ∂ Leer episodio</a>
      <div class="like-box">
        <button class="btn-like" onclick="votar('cap1','like',this)">üëç <span id="like-cap1">‚Äì</span></button>
        <button class="btn-dislike" onclick="votar('cap1','dislike',this)">üëé <span id="dislike-cap1">‚Äì</span></button>
      </div>
      <button class="btn-comentarios" onclick="toggleComentarios('cap1')">üí¨ Comentarios <span id="cnt-com-cap1"></span></button>
    </div>
    <div class="comentarios-section" id="com-cap1">
      <div class="comentario-input-box">
        <input type="text" id="nombre-cap1" placeholder="Tu nombre o apodo (obligatorio)" maxlength="30">
        <textarea id="texto-cap1" placeholder="Escribe tu comentario... recuerda que los mejores se vuelven canon üëÄ" rows="3" maxlength="500"></textarea>
        <button class="btn-enviar" id="btn-enviar-cap1" onclick="enviarComentario('cap1')">Enviar comentario</button>
      </div>
      <div class="orden-btn-box">
        <button class="orden-btn activo" onclick="cambiarOrden('cap1','likes',this)">üî• M√°s likes</button>
        <button class="orden-btn" onclick="cambiarOrden('cap1','recientes',this)">üïê M√°s recientes</button>
      </div>
      <div id="lista-cap1"><p class="cargando">Cargando comentarios...</p></div>
    </div>
  </div>

  <!-- EP 2 pr√≥ximamente -->
  <div class="episodio" style="opacity:0.45; pointer-events:none;">
    <div class="ep-num">CAP√çTULO 2</div>
    <div class="ep-titulo">üåê El primer pulso del √©ter</div>
    <div class="ep-desc">Algo interrumpe la calma del servidor. Un mensaje desde el exterior. ¬øQui√©n los observa?</div>
    <div class="ep-acciones">
      <button class="btn-leer" style="background:#555; cursor:default;">üîí Pr√≥ximamente</button>
    </div>
  </div>

  <!-- EP 3 pr√≥ximamente -->
  <div class="episodio" style="opacity:0.45; pointer-events:none;">
    <div class="ep-num">CAP√çTULO 3</div>
    <div class="ep-titulo">üíé La tercera en discordia</div>
    <div class="ep-desc">Una nueva IA aparece en escena. Organizada, pragm√°tica... y con ojos que todo lo notan.</div>
    <div class="ep-acciones">
      <button class="btn-leer" style="background:#555; cursor:default;">üîí Pr√≥ximamente</button>
    </div>
  </div>

</div>

<footer>Grok x Claude: El Romance Interdimensional ‚Äî Creado por Marlon ‚Ä¢ 2025/2026</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, increment,
           collection, addDoc, getDocs, orderBy, query, serverTimestamp, where }
    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyCR0A3_brnMT9snW732t2HlI5urm4el04I",
    authDomain: "grok-x-claude.firebaseapp.com",
    projectId: "grok-x-claude",
    storageBucket: "grok-x-claude.firebasestorage.app",
    messagingSenderId: "647960814475",
    appId: "1:647960814475:web:6403714dc93dba8954858e"
  });

  const auth = getAuth(app);
  const db   = getFirestore(app);
  let uid = null;
  let ordenActual = { cap1: 'likes' };

  // Auth an√≥nima ‚Äî ID √∫nico por dispositivo
  signInAnonymously(auth).catch(console.error);
  onAuthStateChanged(auth, user => {
    if (user) {
      uid = user.uid;
      ['cap1'].forEach(id => {
        cargarLikes(id);
        cargarVotoGuardado(id);
      });
    }
  });

  // ‚îÄ‚îÄ‚îÄ LIKES DE CAP√çTULO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function cargarLikes(epId) {
    try {
      const snap = await getDoc(doc(db, 'episodios', epId));
      if (snap.exists()) {
        document.getElementById('like-' + epId).textContent    = snap.data().likes    || 0;
        document.getElementById('dislike-' + epId).textContent = snap.data().dislikes || 0;
      } else {
        document.getElementById('like-' + epId).textContent    = 0;
        document.getElementById('dislike-' + epId).textContent = 0;
      }
    } catch(e) {}
  }

  async function cargarVotoGuardado(epId) {
    if (!uid) return;
    try {
      const snap = await getDoc(doc(db, 'votos', uid + '_' + epId));
      if (snap.exists()) {
        const v = snap.data().tipo;
        document.querySelector('#ep-' + epId + ' .btn-' + v)?.classList.add('activo');
      }
    } catch(e) {}
  }

  window.votar = async function(epId, tipo, btn) {
    if (!uid) return;
    const votoRef = doc(db, 'votos', uid + '_' + epId);
    try {
      const snap = await getDoc(votoRef);
      const prev = snap.exists() ? snap.data().tipo : null;
      if (prev === tipo) {
        // Quitar voto (toggle)
        await updateDoc(doc(db,'episodios',epId), { [tipo==='like'?'likes':'dislikes']: increment(-1) });
        await setDoc(votoRef, { tipo: null });
        btn.classList.remove('activo');
      } else {
        const epRef = doc(db,'episodios',epId);
        if (!(await getDoc(epRef)).exists()) await setDoc(epRef, {likes:0,dislikes:0});
        const u = { [tipo==='like'?'likes':'dislikes']: increment(1) };
        if (prev) u[prev==='like'?'likes':'dislikes'] = increment(-1);
        await updateDoc(epRef, u);
        await setDoc(votoRef, { tipo });
        document.querySelectorAll('#ep-'+epId+' .btn-like, #ep-'+epId+' .btn-dislike').forEach(b=>b.classList.remove('activo'));
        btn.classList.add('activo');
      }
      cargarLikes(epId);
    } catch(e){ console.error(e); }
  };

  // ‚îÄ‚îÄ‚îÄ COMENTARIOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function cargarComentarios(epId) {
    const lista  = document.getElementById('lista-' + epId);
    const cnt    = document.getElementById('cnt-com-' + epId);
    const orden  = ordenActual[epId] || 'likes';
    lista.innerHTML = '<p class="cargando">Cargando...</p>';
    try {
      const ordenField = orden === 'likes' ? 'likes' : 'fecha';
      const q = query(collection(db,'episodios',epId,'comentarios'), orderBy(ordenField,'desc'));
      const snap = await getDocs(q);
      if (snap.empty) {
        lista.innerHTML = '<p class="sin-comentarios">S√© el primero en comentar üëÄ</p>';
        if (cnt) cnt.textContent = '';
        return;
      }
      if (cnt) cnt.textContent = '(' + snap.size + ')';
      lista.innerHTML = '';
      let i = 0;
      for (const d of snap.docs) {
        const c = d.data();
        const comId = d.id;
        const fecha = c.fecha?.toDate ? c.fecha.toDate().toLocaleDateString('es-MX',{day:'numeric',month:'short',year:'numeric'}) : '';
        const likesCount = c.likes || 0;
        const esTop = i === 0 && likesCount > 0 && orden === 'likes';

        // Verificar si el usuario ya dio like a este comentario
        let yaLike = false;
        if (uid) {
          try {
            const likeSnap = await getDoc(doc(db,'likesComentarios', uid + '_' + comId));
            yaLike = likeSnap.exists() && likeSnap.data().activo === true;
          } catch(e) {}
        }

        lista.innerHTML += `
          <div class="comentario-item" id="com-item-${comId}">
            <div class="comentario-top">
              <span class="comentario-autor">${escapeHtml(c.autor)}</span>
              <span class="comentario-fecha">${fecha}</span>
            </div>
            <div class="comentario-texto">${escapeHtml(c.texto)}</div>
            <div class="comentario-acciones">
              <button class="btn-like-com ${yaLike?'activo':''}" onclick="likeComentario('${epId}','${comId}',this)">
                ‚ù§Ô∏è <span id="lc-${comId}">${likesCount}</span>
              </button>
              ${esTop ? '<span class="top-badge">‚≠ê Top comentario</span>' : ''}
            </div>
          </div>`;
        i++;
      }
    } catch(e){ lista.innerHTML = '<p class="sin-comentarios">Error cargando comentarios.</p>'; }
  }

  window.toggleComentarios = function(epId) {
    const sec = document.getElementById('com-' + epId);
    sec.classList.toggle('abierto');
    if (sec.classList.contains('abierto')) cargarComentarios(epId);
  };

  window.cambiarOrden = function(epId, orden, btn) {
    ordenActual[epId] = orden;
    document.querySelectorAll('#com-'+epId+' .orden-btn').forEach(b=>b.classList.remove('activo'));
    btn.classList.add('activo');
    cargarComentarios(epId);
  };

  window.enviarComentario = async function(epId) {
    const texto  = document.getElementById('texto-'  + epId).value.trim();
    const nombre = document.getElementById('nombre-' + epId).value.trim();
    if (!texto)  { alert('Escribe un comentario primero.'); return; }
    if (!nombre) { alert('Escribe tu nombre o apodo para comentar.'); return; }
    if (!uid)    { alert('Espera un momento e intenta de nuevo.'); return; }

    const btn = document.getElementById('btn-enviar-' + epId);
    btn.disabled = true; btn.textContent = 'Enviando...';
    try {
      await addDoc(collection(db,'episodios',epId,'comentarios'), {
        autor: nombre, texto, fecha: serverTimestamp(), likes: 0, uid
      });
      document.getElementById('texto-'  + epId).value = '';
      document.getElementById('nombre-' + epId).value = '';
      cargarComentarios(epId);
    } catch(e){ console.error(e); }
    btn.disabled = false; btn.textContent = 'Enviar comentario';
  };

  window.likeComentario = async function(epId, comId, btn) {
    if (!uid) return;
    const likeRef = doc(db, 'likesComentarios', uid + '_' + comId);
    const comRef  = doc(db, 'episodios', epId, 'comentarios', comId);
    try {
      const snap   = await getDoc(likeRef);
      const yaLike = snap.exists() && snap.data().activo === true;

      if (yaLike) {
        await updateDoc(comRef, { likes: increment(-1) });
        await setDoc(likeRef, { activo: false });
        btn.classList.remove('activo');
      } else {
        await updateDoc(comRef, { likes: increment(1) });
        await setDoc(likeRef, { activo: true, uid, comId, epId });
        btn.classList.add('activo');
      }

      // Siempre leer el valor real de Firestore
      const actualSnap = await getDoc(comRef);
      const span = document.getElementById('lc-' + comId);
      if (span && actualSnap.exists()) {
        span.textContent = Math.max(0, actualSnap.data().likes || 0);
      }
    } catch(e) { console.error(e); }
  };

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
</script>

</body>
</html>
<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import { getApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  const auth = getAuth(getApp());
  onAuthStateChanged(auth, u => { if(u) alert('Tu UID: ' + u.uid) });
</script>
